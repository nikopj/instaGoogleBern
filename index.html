<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDD3o_vzkcWmw4-yDtuFZ0F4lioqWn8eU8"></script>
    /*<script src="https://cooper-union-maps-proxy.herokuapp.com/js/draw.js"></script>*/

    <script>

      var draw = function(id, mapOptions, positions, linePositions) {

        var map = new google.maps.Map(document.getElementById(id),
          mapOptions);

        var myLatlng = new google.maps.LatLng(40.7293, -73.9906);

        var bernPath = new google.maps.Polyline({
          path: linePositions,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });

        bernPath.setMap(map);

        //set up some empty arrays to use
        var markers = [];
        var infoWindows = [];
        var popUps = [];

        //create all of the markers on the map
        for (i in positions) {

          var image = "http://www.gilmerfreepress.net/images/upload1/BernieSanders.png";
          // To add the marker to the map, use the 'map' property
          markers[i] = new google.maps.Marker({
              position: positions[i].map,
              map: map,
              icon: image,
              title:"The location of the " + positions[i].title
              // icon: 'http://placehold.it/24x50' //url to images
          });

        }

        //loop through the markers, and add pop-up windows to them
        for (i in markers) {

          //create a template with two placeholder to replace
          var popUpTemplate = '<div class="content">{{html}}<a href="{{link}}">{{content}}</a></div>';

          //replace the content placeholder
          popUps[i] = popUpTemplate.replace('{{content}}', positions[i].title);

          //replace the link placeholder
          popUps[i] = popUps[i].replace('{{link}}', positions[i].link);

          //replace the html placeholder

          if(positions[i].html != undefined) {
            popUps[i] = popUps[i].replace('{{html}}', positions[i].html);
          } else {
            popUps[i] = popUps[i].replace('{{html}}', '');
          }

          //create a new info window
          infoWindows[i] = new google.maps.InfoWindow({
            //the contents is the string-replaced template we created within this loop
            content:popUps[i]
          });

          //when a marker is clicked on
          google.maps.event.addListener(markers[i], 'click', function(innerKey) {
            return function() {
                //comment out the for loop persist each info window
                for (j in markers) {
                  infoWindows[j].close(map, markers[j]);
                }

                //open the infoWindow related to the marker clicked on
                infoWindows[innerKey].open(map, markers[innerKey]);
            }
          }(i));
        }
      } //end of the initiazlize function

      $.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/search/user/berniesanders", function(response){
        var user = response[0].username;
        var id = response[0].id;
        console.log(response);

        $.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/user/"+id+"/recent", function(response2){
          console.log(response2);

          var positionsOfBern = [];
          var latestLoc = response2.length;
          var positionsOfFeel = [];
          var validCounter = 0;
          var bernLine = [];

          for(var i=0; i<response2.length; i++){

              if((response2[i].location) && (response2[i].location.latitude !== null)){
                  if(latestLoc > i){
                    latestLoc = i;
                  }
                  validCounter++;
                  var bernPosition = {
                    "title": response2[i].caption.text,
                    "map": new google.maps.LatLng(response2[i].location.latitude,response2[i].location.longitude),
                    "link": response2[i].link,
                    "html": "<img src='"+response2[i].images.standard_resolution.url+"' width='320px' />"
                  }
                  var bern = {lat: response2[i].location.latitude, lng: response2[i].location.longitude};
                  bernLine.push(bern)
                  positionsOfBern.push(bernPosition);
              }
          }
            console.log(validCounter);

          // $.getJSON("http://http://cooper-union-instagram-proxy.herokuapp.com/search/tag/feelthebern", function(response3){
          //   console.log(response3);
          //
          //   for(var i=0; i<response3.length; i++){
          //
          //       if((response3[i].location) && (response3[i].location.latitude !== null)) {
          //
          //           var feelPosition = {
          //             "title":response3[i].caption.text,
          //             "map": new google.maps.LatLng(response3[i].location.latitude,response3[i].location.longitude),
          //             "link":response3[i].link,
          //             "html": "<img src='"+response3[i].images.standard_resolution.url+"' width='320px' />"
          //           }
          //           positionsOfFeel.push(FeelPosition);
          //         }
          //     }
          //
          //
          //   });




          //var positions = positionsOfBern.concat(positionsOfFeel);
          var mapOptions = {
            zoom: 6,
            center: new google.maps.LatLng(response2[latestLoc].location.latitude,response2[latestLoc].location.longitude)
          };

          draw('map', mapOptions, positionsOfBern, bernLine);

          });
      });
    </script>
    <style>
    html, body, #map {
        height:100%;
        padding:0;
        margin:0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

  </body>
</html>
